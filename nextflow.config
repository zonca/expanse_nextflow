profiles {
  slurm_debug {
    workDir = "/expanse/lustre/scratch/${System.env.USER}/temp_project/nxf_work"
    params.outdir = "/expanse/lustre/scratch/${System.env.USER}/temp_project/results_debug"

    process {
      executor = 'slurm'
      queue    = 'debug'
      time     = '00:10:00'
      cpus     = 2
      memory   = '4 GB'

      clusterOptions = '--account=sds166 --nodes=1 --ntasks=1 -o logs/%x-%j.out -e logs/%x-%j.err'


      // Use node-local scratch on Expanse
      scratch = true
      beforeScript = '''
        set -euo pipefail
        if [[ -n "${SLURM_JOB_ID:-}" ]]; then
          export SCRATCH_DIR="/scratch/$USER/job_${SLURM_JOB_ID}"
          mkdir -p "$SCRATCH_DIR/tmp"
          export TMPDIR="$SCRATCH_DIR/tmp"
          export NXF_OPTS="-Djava.io.tmpdir=$TMPDIR"
          echo "[NF] Using node-local scratch at: $SCRATCH_DIR"
        else
          echo "[NF] Local execution detected; skipping SLURM scratch configuration"
        fi
      '''
    }

    executor {
      queueSize = 1          // only 1 job queued at a time
      submitRateLimit = '1 sec'
      pollInterval = '10 sec'
    }

    singularity {
      enabled = true
      autoMounts = true
      runOptions = '--env TMPDIR=$TMPDIR'
    }

    timeline { enabled = true; file = "logs/nextflow_slurm_executor_timeline.html" }
    report   { enabled = true; file = "logs/nextflow_slurm_executor_report.html"   }
    trace    { enabled = true; file = "logs/nextflow_slurm_executor_trace.txt"     }
    dag      { enabled = true; file = "logs/nextflow_slurm_executor_flowchart.png" }
  }
}
